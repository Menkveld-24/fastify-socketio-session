{"version":3,"sources":["../src/index.ts"],"sourcesContent":["import fastifyPlugin from \"fastify-plugin\";\nimport { Socket } from \"socket.io\";\n\nexport default fastifyPlugin(async function (fastify, opts) {\n    \n    if (!fastify.hasPlugin(\"fastify-socket.io\")) {\n      throw new Error('fastify-socket.io has to be registered before fastify-socketio-session');\n    }\n\n    if (!fastify.hasPlugin(\"fastify-session\")) {\n      throw new Error('@mgcrea/fastify-session has to be registered before fastify-socketio-session');\n    }\n\n    // This is triggered upon first contact of a socket\n    // @ts-expect-error fastify.io is loaded via fastify-socket.io\n    fastify.io.engine.on(\"initial_headers\", async (headers, request) => {\n        // @ts-expect-error This one is loaded via fastify-session\n        await fastify.loadSession(request, request.headers.cookie);\n      });\n}, {\n  fastify: \"4.x\",\n  name: \"fastify-socketio-session\",\n});\n\n/**\n * Socket.IO middleware to refresh the session upon each request.\n * Disconnects the socket if no session is found or could be loaded.\n * \n * @param socket The socket instance\n * @param disconnectWithoutSession Disconnect the socket if no session is found or could be loaded\n * @returns socket.io middleware\n */\nexport const sessionRefreshMiddleware = (socket: Socket, disconnectWithoutSession = true): (event: Event, next: (err?: Error) => void) => void => {\n  return async (event, next) => {\n    try {\n      // @ts-expect-error This one is loaded via fastify-session\n      await socket.request.session.reload(socket.request);\n    } catch (err) {\n      if (disconnectWithoutSession) {\n        socket.disconnect();\n      }\n\n      return next(err);\n    }\n    return next();\n  };\n};\n"],"mappings":";;;;;;;;;;;;;;;;;;;;;;;;;;;;;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA,4BAA0B;AAG1B,IAAO,kBAAQ,sBAAAA,SAAc,eAAgB,SAAS,MAAM;AAExD,MAAI,CAAC,QAAQ,UAAU,mBAAmB,GAAG;AAC3C,UAAM,IAAI,MAAM,wEAAwE;AAAA,EAC1F;AAEA,MAAI,CAAC,QAAQ,UAAU,iBAAiB,GAAG;AACzC,UAAM,IAAI,MAAM,8EAA8E;AAAA,EAChG;AAIA,UAAQ,GAAG,OAAO,GAAG,mBAAmB,OAAO,SAAS,YAAY;AAEhE,UAAM,QAAQ,YAAY,SAAS,QAAQ,QAAQ,MAAM;AAAA,EAC3D,CAAC;AACP,GAAG;AAAA,EACD,SAAS;AAAA,EACT,MAAM;AACR,CAAC;AAUM,IAAM,2BAA2B,CAAC,QAAgB,2BAA2B,SAA8D;AAChJ,SAAO,OAAO,OAAO,SAAS;AAC5B,QAAI;AAEF,YAAM,OAAO,QAAQ,QAAQ,OAAO,OAAO,OAAO;AAAA,IACpD,SAAS,KAAK;AACZ,UAAI,0BAA0B;AAC5B,eAAO,WAAW;AAAA,MACpB;AAEA,aAAO,KAAK,GAAG;AAAA,IACjB;AACA,WAAO,KAAK;AAAA,EACd;AACF;","names":["fastifyPlugin"]}